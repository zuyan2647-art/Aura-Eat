<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†™çœŸæ’®å½±</title>

    <!-- AI ãƒ¢ãƒ‡ãƒ«ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        body {
            font-family: 'Avenir', 'Helvetica Neue', Arial, sans-serif;
            text-align: center;
            padding: 0;
            margin: 0;
            background-color: #f5f7fa;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            color: #e67e22;
            padding: 20px 0 10px;
            margin-bottom: 20px;
            font-size: 1.8em;
            width: 90%;
            max-width: 450px;
            border-bottom: 2px solid #f39c12;
        }

        h2 {
            color: #34495e;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        button {
            padding: 15px 30px;
            font-size: 1.2em;
            font-weight: bold;
            color: white;
            background-color: #2ecc71;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 30px;
            box-shadow: 0 6px 10px rgba(46, 204, 113, 0.4);
            outline: none;
        }

        button:hover:not(:disabled) {
            background-color: #27ae60;
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(46, 204, 113, 0.6);
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        #saveHistoryButton {
            background-color: #f39c12;
            box-shadow: 0 6px 10px rgba(243, 156, 18, 0.4);
            margin-top: 20px;
        }

        #manualSubmitButton {
            background-color: #3498db;
        }

        #webcam-container {
            margin: 0 auto 30px;
            border: 6px solid #34495e;
            border-radius: 12px;
            width: 90vw;
            max-width: 320px;
            aspect-ratio: 4 / 3;
            overflow: hidden;
            background-color: #000;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        #webcam-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        #label-container {
            padding: 20px;
            font-size: 1.5em;
            font-weight: bold;
            color: #d35400;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 400px;
            margin: 0 auto 30px;
        }

        #nutrition-result {
            padding: 15px 20px;
            font-size: 1em;
            background-color: #ecf0f1;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            margin: 0 auto 30px;
            text-align: center;
        }

        #manual-input-container {
            width: 90%;
            max-width: 400px;
            margin: 0 auto 30px;
            padding: 20px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        #manual-input-container input {
            width: 100%;
            padding: 12px;
            margin-bottom: 12px;
            font-size: 1em;
            border: 2px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        #manual-input-container input:focus {
            outline: none;
            border-color: #3498db;
        }

        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }

        .input-row input {
            flex: 1;
            margin-bottom: 0;
        }

        #foodSelect {
            width: 90%;
            max-width: 400px;
            padding: 10px;
            font-size: 1.1em;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        #snackbar {
            visibility: hidden;
            min-width: 240px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 12px;
            position: fixed;
            left: 50%;
            bottom: 40px;
            transform: translateX(-50%);
            font-size: 16px;
            z-index: 9999;
        }

        #snackbar.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @keyframes fadein {
            from { bottom: 20px; opacity: 0; }
            to { bottom: 40px; opacity: 1; }
        }

        @keyframes fadeout {
            from { bottom: 40px; opacity: 1; }
            to { bottom: 20px; opacity: 0; }
        }
        #snackbar {
    visibility: hidden;
    min-width: 250px;
    background-color: #333;
    color: #fff;
    text-align: center;
    border-radius: 8px;
    padding: 14px;
    position: fixed;
    z-index: 9999;
    left: 50%;
    bottom: 30px;
    transform: translateX(-50%);
    font-size: 16px;
}

/* è¡¨ç¤ºæ™‚ */
#snackbar.show {
    visibility: visible;
    animation: fadein 0.4s, fadeout 0.4s 2.6s;
}

@keyframes fadein {
    from { bottom: 10px; opacity: 0; }
    to   { bottom: 30px; opacity: 1; }
}

@keyframes fadeout {
    from { bottom: 30px; opacity: 1; }
    to   { bottom: 10px; opacity: 0; }
}

</style>
</head>

<body>

    <h1>ğŸ² æ–™ç†AIåˆ¤åˆ¥ï¼†æ „é¤Šãƒ»å±¥æ­´æ¤œç´¢</h1>
    <div id="loading-message">AIãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...</div>

    <div id="webcam-container">
        <video id="webcam" autoplay playsinline></video>
    </div>

    <button id="startButton" onclick="init()">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•</button>
    <button id="checkButton" disabled>ãƒã‚§ãƒƒã‚¯</button>

    <hr>

    <h2>AIåˆ¤åˆ¥çµæœ</h2>
    <div id="label-container">
        AIãŒåˆ¤åˆ¥ã™ã‚‹ã®ã‚’å¾…ã£ã¦ã„ã¾ã™...
    </div>

    <h2>ğŸ“Š æ „é¤Šæƒ…å ±</h2>
    <div id="nutrition-result">
        åˆ¤åˆ¥ã•ã‚ŒãŸæ–™ç†ã®æ „é¤Šæƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
    </div>

    <hr>

    <h2>âœï¸ æ‰‹å‹•å…¥åŠ›</h2>
    <div id="manual-input-container">
        <input type="text" id="manualFoodName" placeholder="æ–™ç†åã‚’å…¥åŠ›">
        <div class="input-row">
            <input type="number" id="manualCalories" placeholder="ã‚«ãƒ­ãƒªãƒ¼">
            <input type="number" id="manualProtein" placeholder="ã‚¿ãƒ³ãƒ‘ã‚¯è³ª">
        </div>
        <div class="input-row">
            <input type="number" id="manualFat" placeholder="è„‚è³ª">
            <input type="number" id="manualCarb" placeholder="ç‚­æ°´åŒ–ç‰©">
        </div>
        <button id="manualSubmitButton" style="width:100%;">æ‰‹å‹•ã§è¡¨ç¤º</button>
    </div>

    

    <button id="saveHistoryButton" disabled style="width:90%; max-width:400px;">
        ğŸ“ ç¾åœ¨ã®é£Ÿäº‹ã‚’å±¥æ­´ã«ä¿å­˜
    </button>

    <hr>

    
    <a href="/rireki" style="
        display:block; padding:15px; width:90%; max-width:400px;
        background:#e902be; color:white; border-radius:30px; text-decoration:none; margin-bottom:10px;font-weight: bold">
        ğŸ“–å±¥æ­´ã‚’è¦‹ã‚‹
    </a>

    <a href="/menu" style="
        display:block; padding:15px; width:90%; max-width:400px;
        background:#7f8c8d; color:white; border-radius:30px; text-decoration:none; margin-bottom:40px; font-weight: bold;">
        ğŸ  ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
    </a>
    <div id="snackbar">å±¥æ­´ã«ä¿å­˜ã—ã¾ã—ãŸï¼</div>

    <!-- curry.js -->
    <script src="/static/curry.js"></script>

    <script>
        /* -------------------------------
            ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«æ–™ç†ã‚’è¿½åŠ 
        ------------------------------- */
        window.addEventListener("DOMContentLoaded", () => {
            const select = document.getElementById("foodSelect");
            for (const food in NUTRITION_MAP) {
                const option = document.createElement("option");
                option.value = food;
                option.textContent = food;
                select.appendChild(option);
            }
        });

        function selectFood() {
            const food = document.getElementById("foodSelect").value;
            if (food) {
                showNutrition(food);
                saveHistoryButton.disabled = false;
            }
        }

        /* ----------------------------------------------------
           ã“ã“ãŒæœ€é‡è¦ï¼šå®‰å…¨ãªã‚«ãƒ¡ãƒ©èµ·å‹• init()
        ---------------------------------------------------- */
        async function init() {
            const video = document.getElementById("webcam");

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: { ideal: "environment" },
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                });

                video.srcObject = stream;

                video.onloadedmetadata = () => {
                    video.play();
                };

                document.getElementById("checkButton").disabled = false;

            } catch (e) {
                alert("ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\nãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚");
                console.error(e);
            }
        }

        /* ----------------------------------------------------
           å†™çœŸæ’®å½± â†’ Base64 â†’ API ä¿å­˜
        ---------------------------------------------------- */
        document.addEventListener("DOMContentLoaded", () => {
            const checkButton = document.getElementById("checkButton");

            async function capturePhoto() {
                const video = document.getElementById("webcam");

                const canvas = document.createElement("canvas");
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                const imageData = canvas.toDataURL("image/jpeg", 0.95);

                try {
                    const response = await fetch("/save_image", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            image: imageData,
                            timestamp: new Date().toISOString()
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        const snackbar = document.getElementById("snackbar");
                        snackbar.textContent = "å†™çœŸã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã—ã¾ã—ãŸï¼";
                        snackbar.className = "show";
                        setTimeout(() => {
                            snackbar.className = snackbar.className.replace("show", "");
                        }, 3000);
                    } else {
                        console.error("ç”»åƒä¿å­˜ã‚¨ãƒ©ãƒ¼:", result.error);
                    }
                } catch (error) {
                    console.error("é€šä¿¡ã‚¨ãƒ©ãƒ¼:", error);
                }
            }

            checkButton.addEventListener("click", capturePhoto);
        });
    </script>
<!-- ã‚¹ãƒŠãƒƒã‚¯ãƒãƒ¼ -->
<div id="snackbar"></div>

</body>
</html>
